name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-22.04
    env:
      CC: clang
      CXX: clang++

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          echo "Installing system dependencies..."
          if [ -n "$ACT" ]; then
            apt-get update
            apt-get install -y curl build-essential clang gfortran pkg-config \
              python3 python3-pip xz-utils primesieve
          else
            sudo apt-get update
            sudo apt-get install -y curl build-essential clang gfortran pkg-config \
              python3 python3-pip xz-utils primesieve
          fi

      - name: Install Python dependencies
        run: |
          python -V
          python -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache external libraries
        uses: actions/cache@v4
        id: extlibs-cache
        with:
          path: external
          key: extlibs-${{ runner.os }}-${{ hashFiles('external/install-linux.sh') }}

      - name: Build external libraries (if not cached)
        if: steps.extlibs-cache.outputs.cache-hit != 'true'
        run: |
          chmod +x ./external/install-linux.sh
          ./external/install-linux.sh

          # Export environment variables for later steps
          echo "CPPFLAGS=$CPPFLAGS" >> "$GITHUB_ENV"
          echo "LDFLAGS=$LDFLAGS" >> "$GITHUB_ENV"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH" >> "$GITHUB_ENV"
          echo "PATH=$PATH" >> "$GITHUB_ENV"

      - name: Show environment for debugging
        run: |
          echo "CPPFLAGS=$CPPFLAGS"
          echo "LDFLAGS=$LDFLAGS"
          echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
          echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
          echo "PATH=$PATH"

      - name: Build C++ tools
        run: |
          make -j4

      - name: Run small test
        env:
          LD_LIBRARY_PATH: ${{ env.LD_LIBRARY_PATH }}
        run: |
          ./batch-run -v n -r 10-100 -t dense -a wiedemann -p diagonal -f 31

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: run-results
          path: runs/*/*
