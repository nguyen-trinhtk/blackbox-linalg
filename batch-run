#!/usr/bin/env bash
ATTEMPTS=10
parse_args() {
    DEST_DIR=""
    EXP_NAME=""

    while getopts "v:r:t:a:p:f:d:n:" opt; do
        case "$opt" in
            v) IND_VAR="$OPTARG" ;;        # q or n
            r) RANGE="$OPTARG" ;;          # e.g. 2-5
            t) MAT_TYPE="$OPTARG" ;;
            a) ALGO_TYPE="$OPTARG" ;;
            p) PRECOND_TYPE="$OPTARG" ;;
            f) FIXED_VAR="$OPTARG" ;;
            d) DEST_DIR="$OPTARG" ;;       # optional
            n) EXP_NAME="$OPTARG" ;;       # optional
            *)
                echo "Invalid option." >&2
                exit 1
                ;;
        esac
    done

    if [[ -z "$IND_VAR" || -z "$RANGE" || -z "$MAT_TYPE" || -z "$ALGO_TYPE" || -z "$PRECOND_TYPE" || -z "$FIXED_VAR" ]]; then
        echo "Error: missing required arguments." >&2
        echo "Usage: $0 -v q|n -r start-stop -t type -a algo -p precond -f fixed [-d dest] [-n name]" >&2
        exit 1
    fi

    IFS="-" read -r START STOP <<< "$RANGE"

    if [[ -z "$START" || -z "$STOP" ]]; then
        echo "Invalid range format. Expected start-stop." >&2
        exit 1
    fi

    timestamp="$(date +"%Y-%m-%d_%H:%M:%S")"

    if [[ -n "$DEST_DIR" ]]; then
        RUN_DIR="${DEST_DIR%/}/$timestamp"
    else
        RUN_DIR="runs/$timestamp"
    fi
    mkdir -p "$RUN_DIR"
}

# Requires primesieve
generate_var_list() {
    Q_LIST=()
    N_LIST=()

    if [[ "$IND_VAR" == "n" ]]; then
        # primality handling?
        N_LIST=($(seq "$START" "$STOP"))
        Q_LIST=($FIXED_VAR)
    else
        N_LIST=($FIXED_VAR)
        primes="$(primesieve "$START" "$STOP" --print)"
        while IFS= read -r p; do
            Q_LIST+=("$p")
        done <<< "$primes"
    fi

    N_FILE="$RUN_DIR/n_list.txt"
    Q_FILE="$RUN_DIR/q_list.txt"

    printf "%s\n" "${N_LIST[@]}" > "$N_FILE"
    printf "%s\n" "${Q_LIST[@]}" > "$Q_FILE"
}

print_check() {
    echo "Fact check"
    echo "$START"
    echo "$STOP"
    echo "${Q_LIST[@]}"
    echo "${N_LIST[@]}"
}

solve_original() {
    for SMS_FILE in "$RUN_DIR/trial-$TRIAL/matrix"/*.sms; do
        FILE=$(basename "$SMS_FILE")
        if [[ "$FILE" =~ ^([0-9]+)x[0-9]+-GF([0-9]+)\.sms$ ]]; then
            N="${BASH_REMATCH[1]}"
            Q="${BASH_REMATCH[2]}"
        else
            echo "Filename format unrecognized: $FILE" >&2
            continue
        fi

        ./build/solver/run_wiedemann "$SMS_FILE"
        RESULT=$?

        echo "$TRIAL,$N,$Q,$RESULT,0" >> "$RAW_RES_FILE"
    done
}
solve_precond() {
    for SMS_FILE in "$RUN_DIR/trial-$TRIAL/fin"/*.sms; do
        FILE=$(basename "$SMS_FILE")
        if [[ "$FILE" =~ ^([0-9]+)x[0-9]+-GF([0-9]+)\.sms$ ]]; then
            N="${BASH_REMATCH[1]}"
            Q="${BASH_REMATCH[2]}"
        else
            echo "Filename format unrecognized: $FILE" >&2
            continue
        fi

        ./build/solver/run_wiedemann "$SMS_FILE"
        RESULT=$?

        echo "$TRIAL,$N,$Q,$RESULT,1" >> "$RAW_RES_FILE"
    done
}

parse_args "$@"
generate_var_list
RAW_RES_FILE="$RUN_DIR/raw-results.csv"
PROCESSED_RES_FILE="$RUN_DIR/processed-results.csv"
touch "$RAW_RES_FILE"

echo "trial,n,q,success,precond?" >> "$RAW_RES_FILE"
# print_check
make
for (( TRIAL=1; TRIAL < ( ATTEMPTS + 1 ); TRIAL++ )); do
    echo "Trial $TRIAL:"
    mkdir -p "$RUN_DIR/trial-$TRIAL"
    mkdir -p "$RUN_DIR/trial-$TRIAL/matrix"
    mkdir -p "$RUN_DIR/trial-$TRIAL/precond"
    mkdir -p "$RUN_DIR/trial-$TRIAL/fin"
    ./build/solver/generate_matrix "$MAT_TYPE" "$N_FILE" "$Q_FILE" "$RUN_DIR/trial-$TRIAL/matrix"
    ./build/solver/generate_matrix "$PRECOND_TYPE" "$N_FILE" "$Q_FILE" "$RUN_DIR/trial-$TRIAL/precond"
    ./build/solver/apply_precond "$N_FILE" "$Q_FILE" "$RUN_DIR/trial-$TRIAL/matrix" "$RUN_DIR/trial-$TRIAL/precond" "$RUN_DIR/trial-$TRIAL/fin"
    python3 src/utils/convert_format.py "$RUN_DIR/trial-$TRIAL"
    # echo "ORIGINAL"
    solve_original
    # echo "PRECOND"
    solve_precond
done
python3 ./src/utils/preprocess_csv.py "$RAW_RES_FILE" "$PROCESSED_RES_FILE"
python3 ./src/analyzer/main.py "$PROCESSED_RES_FILE" "$IND_VAR" "$RUN_DIR"
